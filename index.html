<html>
    <head>
        <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
        <style>
            body {font-family: sans-serif; padding: 1em 5em}
            .layers div {
                border: 2px solid;
                padding: 10px;
                margin-bottom: 1em;
            }
        </style>

        <script>
            async function loadData() {
                const response = await fetch('http://maturity-model.online/mm_data.json', {
                    mode: 'cors',
                    headers: {'Access-Control-Allow-Origin':'*'}
                });
                const mm_data = await response.json();
                return mm_data[0]
            }
            
            // helper to get a random sample from list
            function getRandomSample(array, size) {
                var shuffled = array.slice(0), i = array.length, temp, index;
                while (i--) {
                    index = Math.floor((i + 1) * Math.random());
                    temp = shuffled[index];
                    shuffled[index] = shuffled[i];
                    shuffled[i] = temp;
                }
                return shuffled.slice(0, size);
            }

            // Simple helper to convert hex color values to RGB 
            // so we can mess with them, then return a new color
            // Note: not currently used
            function lightenColor(hex) {
                let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                let r = parseInt(result[1], 16),
                    g = parseInt(result[2], 16),
                    b = parseInt(result[3], 16)
                    newr = Math.round( r + Math.min( 255-r, 50 )), // approximately 20% lighter
                    newg =  Math.round( g + Math.min( 255-g, 50 )),
                    newb =  Math.round( b + Math.min( 255-b, 50 ));
                let rgbVal = "rgb(" + newr + "," + newg + "," + newb + ")";
                return "#" + ((1 << 24) + (newr << 16) + (newg << 8) + newb).toString(16).slice(1);
            }

            function buildModel() {
                const layerCount = ~~(Math.random() * 5) + 2;
                layers = []
                
                loadData();
                console.log('mm_data', mm_data);
                let colors = mm_data.colors,
                    positiveHeds = mm_data.positiveHeds,
                    negativeHeds = mm_data.negativeHeds,
                    deks = mm_data.deks;
                
                console.log('positiveHeds', positiveHeds)

                // Get some random samples
                const topHalf = getRandomSample(positiveHeds, Math.ceil(layerCount/2));
                const bottomHalf = getRandomSample(negativeHeds, Math.ceil(layerCount/2));
                const randomHeds = [...topHalf, ...bottomHalf]
                const randomDeks = getRandomSample(deks, layerCount);
                // random colors needs to be sorted back into order
                var randomColors = getRandomSample(colors, layerCount);
                randomColors.sort((a, b) => (a.order > b.order) ? 1 : -1)

                // Now build our layers
                for (var i = 0; i < layerCount; i++) {
                    let bgcolor = lightenColor(randomColors[i].hex);
                    layers.push({
                        index: i+1,
                        hed: randomHeds[i],
                        dek: randomDeks[i],
                        color: randomColors[i],
                        bgcolor: bgcolor
                    })
                }
                return {
                    layers: layers,
                }
            }
            buildModel();
        </script>
    </head>
    <body>
        <h1>Your new (generated) maturity model</h1>
        <div class="layers" x-data="{ layers }">
            <template x-for="layer in layers">
                <div x-bind:style="`border-color: ${layer.color.name}; border-left: 100px solid ${layer.color.name}`">

                    <h2 x-text="layer.hed"></h2>

                    <p x-text="layer.dek"></p>

                </div>
            </template>
        </div>
    </body>
</html>